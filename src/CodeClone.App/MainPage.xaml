<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CodeClone.App.ViewModels"
             x:Class="CodeClone.App.MainPage"
             x:DataType="vm:MainViewModel"
             Title="CodeClone Desktop">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Toolbar -->
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}"
                Padding="12,8">
            <Grid ColumnDefinitions="Auto,Auto,Auto,Auto,*,Auto">
                <Button Text="Open Repo"
                        Command="{Binding OpenRepoCommand}"
                        Margin="0,0,8,0"/>
                <Button Grid.Column="1"
                        Text="âš¡ Assess Risk"
                        Command="{Binding AssessRiskCommand}"
                        IsEnabled="{Binding IsAnalyzing, Converter={StaticResource InvertBool}}"
                        BackgroundColor="#1976D2"
                        TextColor="White"
                        Margin="0,0,8,0"/>
                <Button Grid.Column="2"
                        Text="â† Insights"
                        Command="{Binding ShowInsightsCommand}"
                        IsVisible="{Binding HasAnalysis}"
                        Margin="0,0,4,0"/>
                <Button Grid.Column="3"
                        Text="Details â†’"
                        Command="{Binding ShowDetailsCommand}"
                        IsVisible="{Binding HasAnalysis}"
                        Margin="0,0,8,0"/>
                <ActivityIndicator Grid.Column="4"
                                   IsRunning="{Binding IsAnalyzing}"
                                   IsVisible="{Binding IsAnalyzing}"
                                   HeightRequest="20"
                                   HorizontalOptions="Start"/>

                <!-- Risk Score Badge (tappable for explanation) -->
                <Border Grid.Column="5"
                        BackgroundColor="{Binding RiskColor}"
                        Padding="12,6"
                        StrokeShape="RoundRectangle 6"
                        IsVisible="{Binding HasAnalysis}">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding ShowScoreExplainerCommand}"/>
                    </Border.GestureRecognizers>
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="RISK:"
                               TextColor="White"
                               FontSize="11"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding RiskLevel}"
                               TextColor="White"
                               FontAttributes="Bold"
                               FontSize="14"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding RiskScore, StringFormat='({0})'}"
                               TextColor="#FFFFFFCC"
                               FontSize="11"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding TrendIcon}"
                               TextColor="White"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               IsVisible="{Binding HasComparison}"/>
                        <Label Text="â“˜"
                               TextColor="#FFFFFFAA"
                               FontSize="12"
                               VerticalOptions="Center"/>
                    </HorizontalStackLayout>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="1">

            <!-- FIRST-RUN / NO REPO STATE -->
            <VerticalStackLayout IsVisible="{Binding HasRepo, Converter={StaticResource InvertBool}}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="24"
                                 Padding="48">
                <Label Text="ðŸ”"
                       FontSize="64"
                       HorizontalOptions="Center"/>
                <Label Text="Understand Your Code Quality"
                       FontSize="28"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       TextColor="#1976D2"/>
                <Label Text="CodeClone Desktop helps you find and fix quality issues&#10;before they become technical debt."
                       FontSize="16"
                       HorizontalOptions="Center"
                       HorizontalTextAlignment="Center"
                       TextColor="#616161"/>
                <Button Text="Open a Repository"
                        Command="{Binding OpenRepoCommand}"
                        BackgroundColor="#1976D2"
                        TextColor="White"
                        Padding="24,12"
                        FontSize="16"
                        HorizontalOptions="Center"/>
                <Label Text="Privacy-first: All analysis runs locally. Your code never leaves your machine."
                       FontSize="12"
                       TextColor="#9E9E9E"
                       HorizontalOptions="Center"/>
            </VerticalStackLayout>

            <!-- REPO LOADED, NO ANALYSIS YET -->
            <VerticalStackLayout IsVisible="{Binding ShowWelcome}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="20"
                                 Padding="48">
                <Label Text="ðŸ“‚"
                       FontSize="48"
                       HorizontalOptions="Center"/>
                <Label Text="{Binding RepoName, StringFormat='Ready to assess: {0}'}"
                       FontSize="22"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"/>
                <Label Text="Click 'Assess Risk' to analyze code quality and get actionable insights."
                       FontSize="14"
                       HorizontalOptions="Center"
                       TextColor="#757575"/>
                <Button Text="âš¡ Assess Risk"
                        Command="{Binding AssessRiskCommand}"
                        BackgroundColor="#1976D2"
                        TextColor="White"
                        Padding="24,12"
                        FontSize="16"
                        HorizontalOptions="Center"/>
                <VerticalStackLayout Spacing="8" Margin="0,16,0,0">
                    <Label Text="What you'll get:"
                           FontSize="12"
                           FontAttributes="Bold"
                           TextColor="#757575"
                           HorizontalOptions="Center"/>
                    <Label Text="âœ“ Risk score with plain-language explanation"
                           FontSize="12"
                           TextColor="#9E9E9E"
                           HorizontalOptions="Center"/>
                    <Label Text="âœ“ Prioritized list of what to fix first"
                           FontSize="12"
                           TextColor="#9E9E9E"
                           HorizontalOptions="Center"/>
                    <Label Text="âœ“ Before/after comparison with history"
                           FontSize="12"
                           TextColor="#9E9E9E"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </VerticalStackLayout>

            <!-- INSIGHT DASHBOARD -->
            <ScrollView IsVisible="{Binding ShowDashboard}">
                <VerticalStackLayout Padding="24" Spacing="20">

                    <!-- Decision Summary Card -->
                    <Border BackgroundColor="{Binding InsightBackgroundColor}"
                            Padding="24"
                            StrokeShape="RoundRectangle 12"
                            Stroke="{Binding InsightColor}"
                            StrokeThickness="2">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="{Binding InsightHeadline}"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="{Binding InsightColor}"/>
                            <Label Text="{Binding InsightSubtext}"
                                   FontSize="16"
                                   TextColor="#424242"/>
                            <BoxView HeightRequest="1" Color="#E0E0E0" Margin="0,8"/>
                            <Label Text="Why this matters:"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="#757575"/>
                            <Label Text="{Binding InsightWhyItMatters}"
                                   FontSize="14"
                                   TextColor="#616161"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Trend Alert -->
                    <Border BackgroundColor="{Binding TrendColor}"
                            Padding="16"
                            StrokeShape="RoundRectangle 8"
                            IsVisible="{Binding HasTrendInsight}">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding TrendHeadline}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="White"/>
                            <Label Text="{Binding TrendSubtext}"
                                   FontSize="13"
                                   TextColor="#FFFFFFCC"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Score Explainer (expandable) -->
                    <Border BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}"
                            Padding="16"
                            StrokeShape="RoundRectangle 8"
                            IsVisible="{Binding ShowScoreExplainer}">
                        <VerticalStackLayout Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="ðŸ“Š How the Risk Score Works"
                                       FontSize="14"
                                       FontAttributes="Bold"/>
                                <Label Grid.Column="1"
                                       Text="âœ•"
                                       TextColor="Gray"
                                       FontSize="16">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding HideScoreExplainerCommand}"/>
                                    </Label.GestureRecognizers>
                                </Label>
                            </Grid>
                            <Label Text="{Binding ScoreExplanation}"
                                   FontSize="13"
                                   TextColor="#616161"/>
                            <CollectionView ItemsSource="{Binding ScoreFactors}"
                                            HeightRequest="120">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:ScoreFactorViewModel">
                                        <Grid ColumnDefinitions="*,Auto,60" Padding="0,4">
                                            <Label Text="{Binding Name}"
                                                   FontSize="12"/>
                                            <ProgressBar Grid.Column="1"
                                                         Progress="{Binding NormalizedValue}"
                                                         WidthRequest="100"
                                                         ProgressColor="{Binding ProgressColor}"/>
                                            <Label Grid.Column="2"
                                                   Text="{Binding WeightedContribution, StringFormat='+{0}'}"
                                                   FontSize="12"
                                                   HorizontalTextAlignment="End"
                                                   TextColor="Gray"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Key Metrics -->
                    <Label Text="Key Metrics"
                           FontSize="18"
                           FontAttributes="Bold"
                           Margin="0,8,0,0"/>
                    <Grid ColumnDefinitions="*,*,*,*" ColumnSpacing="16">
                        <Border BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2D2D2D}"
                                Padding="16"
                                StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout>
                                <Label Text="{Binding DuplicationPercent, StringFormat='{0:F1}%'}"
                                       FontSize="28"
                                       FontAttributes="Bold"
                                       TextColor="#1976D2"/>
                                <Label Text="Estimated Duplication"
                                       FontSize="11"
                                       TextColor="Gray"/>
                            </VerticalStackLayout>
                        </Border>
                        <Border Grid.Column="1"
                                BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2D2D2D}"
                                Padding="16"
                                StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout>
                                <Label Text="{Binding HotspotCount}"
                                       FontSize="28"
                                       FontAttributes="Bold"
                                       TextColor="#F57C00"/>
                                <Label Text="Risk Hotspots"
                                       FontSize="11"
                                       TextColor="Gray"/>
                            </VerticalStackLayout>
                        </Border>
                        <Border Grid.Column="2"
                                BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2D2D2D}"
                                Padding="16"
                                StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout>
                                <Label Text="{Binding AffectedFiles}"
                                       FontSize="28"
                                       FontAttributes="Bold"
                                       TextColor="#7B1FA2"/>
                                <Label Text="Affected Areas"
                                       FontSize="11"
                                       TextColor="Gray"/>
                            </VerticalStackLayout>
                        </Border>
                        <Border Grid.Column="3"
                                BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#2D2D2D}"
                                Padding="16"
                                StrokeShape="RoundRectangle 8">
                            <VerticalStackLayout>
                                <Label Text="{Binding AffectedLines}"
                                       FontSize="28"
                                       FontAttributes="Bold"
                                       TextColor="#455A64"/>
                                <Label Text="Lines at Risk"
                                       FontSize="11"
                                       TextColor="Gray"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- What Should I Fix First? -->
                    <Label Text="ðŸ“‹ What Should I Fix First?"
                           FontSize="18"
                           FontAttributes="Bold"
                           Margin="0,16,0,0"/>
                    <Border BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                            Padding="0"
                            StrokeShape="RoundRectangle 8"
                            Stroke="#E0E0E0">
                        <CollectionView ItemsSource="{Binding ActionItems}"
                                        SelectedItem="{Binding SelectedAction, Mode=TwoWay}"
                                        SelectionMode="Single">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:ActionItemViewModel">
                                    <Border Padding="16"
                                            BackgroundColor="Transparent"
                                            StrokeThickness="0">
                                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                            <Label Text="{Binding PriorityIcon}"
                                                   FontSize="20"
                                                   VerticalOptions="Start"
                                                   Margin="0,0,12,0"/>
                                            <VerticalStackLayout Grid.Column="1" Spacing="4">
                                                <Label Text="{Binding FileName}"
                                                       FontAttributes="Bold"
                                                       FontSize="14"/>
                                                <Label Text="{Binding Item.Problem}"
                                                       FontSize="13"
                                                       TextColor="#424242"/>
                                            </VerticalStackLayout>
                                            <Border Grid.Column="2"
                                                    BackgroundColor="{Binding PriorityColor}"
                                                    Padding="8,4"
                                                    StrokeShape="RoundRectangle 4"
                                                    VerticalOptions="Start">
                                                <Label Text="{Binding PriorityText}"
                                                       TextColor="White"
                                                       FontSize="11"
                                                       FontAttributes="Bold"/>
                                            </Border>
                                            <Label Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                                                   Text="{Binding Item.Recommendation}"
                                                   FontSize="12"
                                                   TextColor="#757575"
                                                   Margin="0,8,0,0"/>
                                            <Label Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2"
                                                   Text="{Binding Item.ImpactExplanation}"
                                                   FontSize="11"
                                                   TextColor="#9E9E9E"
                                                   FontAttributes="Italic"
                                                   Margin="0,4,0,0"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <Label Text="No issues found - your code is in great shape! ðŸŽ‰"
                                       TextColor="Gray"
                                       HorizontalOptions="Center"
                                       Margin="0,40"/>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </Border>

                </VerticalStackLayout>
            </ScrollView>

            <!-- DETAILS VIEW with Breadcrumb -->
            <Grid RowDefinitions="Auto,*"
                  IsVisible="{Binding ShowDetailsView}">
                <!-- Breadcrumb Bar -->
                <Border BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#1A237E}"
                        Padding="12,8">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="â† Back to Insights"
                               TextColor="#1976D2"
                               TextDecorations="Underline">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ShowInsightsCommand}"/>
                            </Label.GestureRecognizers>
                        </Label>
                        <Label Text="/"
                               TextColor="Gray"/>
                        <Label Text="{Binding CurrentFileName, StringFormat='Viewing: {0}'}"
                               TextColor="#424242"
                               FontAttributes="Bold"/>
                    </HorizontalStackLayout>
                </Border>

                <!-- File Browser + Code -->
                <Grid Grid.Row="1" ColumnDefinitions="250,*,200">
                    <!-- File Tree -->
                    <Border BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1E1E1E}"
                            Margin="0,0,1,0">
                        <Grid RowDefinitions="Auto,*">
                            <Label Text="Affected Areas"
                                   FontAttributes="Bold"
                                   Padding="12,8"
                                   BackgroundColor="{AppThemeBinding Light=#EEEEEE, Dark=#333333}"/>
                            <CollectionView Grid.Row="1"
                                            ItemsSource="{Binding FileTree}"
                                            SelectedItem="{Binding SelectedFile, Mode=TwoWay}"
                                            SelectionMode="Single">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:FileTreeItem">
                                        <Grid Padding="8,4" ColumnDefinitions="Auto,*,Auto">
                                            <Label Text="{Binding Icon}"
                                                   FontFamily="Segoe MDL2 Assets"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="1"
                                                   Text="{Binding Name}"
                                                   Margin="4,0"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="2"
                                                   Text="{Binding DiagnosticDisplay}"
                                                   TextColor="Orange"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </Border>

                    <!-- Code Viewer -->
                    <Grid Grid.Column="1" RowDefinitions="Auto,*">
                        <Grid ColumnDefinitions="*,Auto"
                              BackgroundColor="{AppThemeBinding Light=#EEEEEE, Dark=#333333}">
                            <Label Text="{Binding CurrentFileName}"
                                   FontAttributes="Bold"
                                   Padding="12,8"/>
                            <Label Grid.Column="1"
                                   Text="{Binding CurrentFileIssueCount, StringFormat='{0} issues in this file'}"
                                   TextColor="Gray"
                                   Padding="12,8"
                                   IsVisible="{Binding HasCurrentFile}"/>
                        </Grid>
                        <CollectionView Grid.Row="1"
                                        ItemsSource="{Binding CodeLines}"
                                        SelectionMode="None">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="vm:CodeLine">
                                    <Grid ColumnDefinitions="50,*"
                                          BackgroundColor="{Binding BackgroundColor}"
                                          Padding="4,2">
                                        <Label Text="{Binding LineNumber}"
                                               TextColor="{Binding LineNumberColor}"
                                               HorizontalTextAlignment="End"
                                               FontFamily="Consolas"
                                               FontSize="12"
                                               Margin="0,0,8,0"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding Text}"
                                               FontFamily="Consolas"
                                               FontSize="12"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <Label Text="Select a file to view its contents"
                                       TextColor="Gray"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"/>
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </Grid>

                    <!-- Hotspots Panel -->
                    <Border Grid.Column="2"
                            BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2723}"
                            Margin="1,0,0,0">
                        <Grid RowDefinitions="Auto,*">
                            <Label Text="ðŸ”¥ Risk Hotspots"
                                   FontAttributes="Bold"
                                   Padding="12,8"
                                   BackgroundColor="{AppThemeBinding Light=#FFE082, Dark=#5D4037}"/>
                            <CollectionView Grid.Row="1"
                                            ItemsSource="{Binding Hotspots}"
                                            SelectedItem="{Binding SelectedHotspot, Mode=TwoWay}"
                                            SelectionMode="Single">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="vm:HotspotItem">
                                        <Grid Padding="8,6" RowDefinitions="Auto,Auto">
                                            <HorizontalStackLayout Spacing="4">
                                                <Label Text="{Binding Icon}"
                                                       FontFamily="Segoe MDL2 Assets"
                                                       TextColor="{Binding IconColor}"
                                                       VerticalOptions="Center"/>
                                                <Label Text="{Binding FileName}"
                                                       FontAttributes="Bold"
                                                       VerticalOptions="Center"
                                                       LineBreakMode="TailTruncation"/>
                                            </HorizontalStackLayout>
                                            <Label Grid.Row="1"
                                                   Text="{Binding Summary}"
                                                   FontSize="11"
                                                   TextColor="Gray"
                                                   Margin="20,0,0,0"/>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Label Grid.Row="2"
               Text="{Binding StatusText}"
               Padding="12,4"
               BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#252525}"
               FontSize="11"/>
    </Grid>

</ContentPage>

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:CodeClone.App.ViewModels"
             x:Class="CodeClone.App.MainPage"
             x:DataType="vm:MainViewModel"
             Title="CodeClone Desktop">

    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto">
        <!-- Toolbar -->
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}"
                Padding="12,8">
            <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto">
                <Button Text="Open Repo"
                        Command="{Binding OpenRepoCommand}"
                        Margin="0,0,8,0"/>
                <Button Grid.Column="1"
                        Text="Run Analysis"
                        Command="{Binding RunAnalysisCommand}"
                        IsEnabled="{Binding IsAnalyzing, Converter={StaticResource InvertBool}}"
                        Margin="0,0,8,0"/>
                <Button Grid.Column="2"
                        Text="History"
                        Command="{Binding ViewHistoryCommand}"
                        Margin="0,0,8,0"/>
                <ActivityIndicator Grid.Column="3"
                                   IsRunning="{Binding IsAnalyzing}"
                                   IsVisible="{Binding IsAnalyzing}"
                                   HeightRequest="20"
                                   HorizontalOptions="Start"/>

                <!-- Risk Score Badge (The Headline Metric) -->
                <Border Grid.Column="4"
                        BackgroundColor="{Binding RiskColor}"
                        Padding="12,6"
                        StrokeShape="RoundRectangle 6">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="RISK:"
                               TextColor="White"
                               FontSize="11"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding RiskLevel}"
                               TextColor="White"
                               FontAttributes="Bold"
                               FontSize="14"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding RiskScore, StringFormat='({0})'}"
                               TextColor="#FFFFFFCC"
                               FontSize="11"
                               VerticalOptions="Center"/>
                        <Label Text="{Binding TrendIcon}"
                               TextColor="{Binding TrendColor}"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               IsVisible="{Binding HasComparison}"/>
                    </HorizontalStackLayout>
                </Border>
            </Grid>
        </Border>

        <!-- Comparison Banner (shows when we have delta) -->
        <Border Grid.Row="1"
                BackgroundColor="{Binding TrendColor}"
                Padding="12,6"
                IsVisible="{Binding HasComparison}">
            <Label TextColor="White"
                   HorizontalOptions="Center">
                <Label.FormattedText>
                    <FormattedString>
                        <Span Text="vs last analysis: "/>
                        <Span Text="{Binding DiagnosticDelta, StringFormat='{0:+#;-#;0} issues'}"
                              FontAttributes="Bold"/>
                    </FormattedString>
                </Label.FormattedText>
            </Label>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="2" ColumnDefinitions="250,*,200">
            <!-- File Tree -->
            <Border BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1E1E1E}"
                    Margin="0,0,1,0">
                <Grid RowDefinitions="Auto,*">
                    <Label Text="Files"
                           FontAttributes="Bold"
                           Padding="12,8"
                           BackgroundColor="{AppThemeBinding Light=#EEEEEE, Dark=#333333}"/>
                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding FileTree}"
                                    SelectedItem="{Binding SelectedFile, Mode=TwoWay}"
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="vm:FileTreeItem">
                                <Grid Padding="8,4" ColumnDefinitions="Auto,*,Auto">
                                    <Label Text="{Binding Icon}"
                                           FontFamily="Segoe MDL2 Assets"
                                           VerticalOptions="Center"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding Name}"
                                           Margin="4,0"
                                           VerticalOptions="Center"/>
                                    <Label Grid.Column="2"
                                           Text="{Binding DiagnosticDisplay}"
                                           TextColor="Orange"
                                           VerticalOptions="Center"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Border>

            <!-- Code Viewer -->
            <Grid Grid.Column="1" RowDefinitions="Auto,*">
                <Label Text="{Binding CurrentFileName}"
                       FontAttributes="Bold"
                       Padding="12,8"
                       BackgroundColor="{AppThemeBinding Light=#EEEEEE, Dark=#333333}"/>
                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding CodeLines}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:CodeLine">
                            <Grid ColumnDefinitions="50,*"
                                  BackgroundColor="{Binding BackgroundColor}"
                                  Padding="4,2">
                                <Label Text="{Binding LineNumber}"
                                       TextColor="{Binding LineNumberColor}"
                                       HorizontalTextAlignment="End"
                                       FontFamily="Consolas"
                                       FontSize="12"
                                       Margin="0,0,8,0"/>
                                <Label Grid.Column="1"
                                       Text="{Binding Text}"
                                       FontFamily="Consolas"
                                       FontSize="12"/>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>

            <!-- Hotspots Panel (Right Sidebar) -->
            <Border Grid.Column="2"
                    BackgroundColor="{AppThemeBinding Light=#FFF8E1, Dark=#3E2723}"
                    Margin="1,0,0,0">
                <Grid RowDefinitions="Auto,*">
                    <Label Text="ðŸ”¥ Hotspots"
                           FontAttributes="Bold"
                           Padding="12,8"
                           BackgroundColor="{AppThemeBinding Light=#FFE082, Dark=#5D4037}"/>
                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding Hotspots}"
                                    SelectedItem="{Binding SelectedHotspot, Mode=TwoWay}"
                                    SelectionMode="Single">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="vm:HotspotItem">
                                <Grid Padding="8,6" RowDefinitions="Auto,Auto">
                                    <HorizontalStackLayout Spacing="4">
                                        <Label Text="{Binding Icon}"
                                               FontFamily="Segoe MDL2 Assets"
                                               TextColor="{Binding IconColor}"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding FileName}"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation"/>
                                    </HorizontalStackLayout>
                                    <Label Grid.Row="1"
                                           Text="{Binding Summary}"
                                           FontSize="11"
                                           TextColor="Gray"
                                           Margin="20,0,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.EmptyView>
                            <Label Text="Run analysis to see hotspots"
                                   TextColor="Gray"
                                   HorizontalOptions="Center"
                                   Margin="0,20"/>
                        </CollectionView.EmptyView>
                    </CollectionView>
                </Grid>
            </Border>
        </Grid>

        <!-- Diagnostics Panel -->
        <Border Grid.Row="3"
                BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1E1E1E}"
                HeightRequest="150">
            <Grid RowDefinitions="Auto,*">
                <Grid ColumnDefinitions="*,Auto"
                      BackgroundColor="{AppThemeBinding Light=#EEEEEE, Dark=#333333}">
                    <Label Text="Diagnostics"
                           FontAttributes="Bold"
                           Padding="12,8"/>
                    <Label Grid.Column="1"
                           Text="{Binding TotalDiagnostics, StringFormat='{0} total'}"
                           TextColor="Gray"
                           Padding="12,8"/>
                </Grid>
                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding Diagnostics}"
                                SelectedItem="{Binding SelectedDiagnostic, Mode=TwoWay}"
                                SelectionMode="Single">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:DiagnosticItem">
                            <Grid Padding="12,6" ColumnDefinitions="Auto,Auto,*">
                                <Label Text="{Binding Icon}"
                                       FontFamily="Segoe MDL2 Assets"
                                       TextColor="{Binding IconColor}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding Location}"
                                       TextColor="Gray"
                                       Margin="8,0"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="2"
                                       Text="{Binding Summary}"
                                       VerticalOptions="Center"
                                       LineBreakMode="TailTruncation"/>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Label Grid.Row="4"
               Text="{Binding StatusText}"
               Padding="12,4"
               BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#252525}"
               FontSize="11"/>
    </Grid>

</ContentPage>
